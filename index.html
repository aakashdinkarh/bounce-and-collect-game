<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <title>Move The Ball</title>
  <style>
    #field {
      width: 800px;
      height: 400px;
      border: 10px solid black;
      background-color: #00FF00;
      overflow: hidden;
      position: relative;
			user-select: none;
			transition: all 1s;
    }
    #ball {
			top: 0px;
      left: 0px;
      position: absolute;
    }

		.coords {
			position: fixed;
			right: 0;
			top: 0;
		}
		.outer-coords, .inner-coords {
			padding-left: 10px;
		}

  </style>
</head>

<body>

  Click on a field to move the ball there.
  <br> The ball should never leave the field.

	<section>
		<div id="field">
			<img src="https://en.js.cx/clipart/ball.svg" id="ball">
		</div>

		<p class="field-dimension" >
			<div class="field-width"></div>
			<div class="field-height"></div>
		</p>
	</section>

	<form onsubmit="handleSubmit(event)" >
		<label>
			Elasticity constant, e =
			<input name="elasticity" type="number" max="0.99" min="0.1" step="0.01" value="0.5" />
		</label>

		<label>
			Gravity constant, g = 
			<input name="gravity" type="number" max="1" min="0.01" step="0.01" value="0.08" />
		</label>
		
		<button type="submit">Save</button>
	</form>

	</div>

	<section class="coords">
		<section class="mouse-coords" >
			Mouse corrdinates: 
			<div class="coordinates"></div>
			<div class="coordinates"></div>
		</section>

		<br />

		<section class="field-coords">
			Field Coordinates:
			<section class="outer-coords">
				Outer:
				<div class="coordinates"></div>
				<div class="coordinates"></div>	
			</section>

			<br />

			<section class="inner-coords">
				Inner:
				<div class="coordinates"></div>
				<div class="coordinates"></div>	
			</section>
		</section>
	</section>

  <script>
		let g = 0.08;
		let e = 0.8;

		const ball = document.getElementById('ball');
		const field = document.getElementById('field');

		function handleSubmit(event, data) {
			event.preventDefault();
			const form = event.target;

			e = form.elasticity.value;
			g = form.gravity.value;

			ball.style.top = 0 + 'px';
			ball.style.left = 0 + 'px';

			freeFall();
		}

		const { width: ballWidth, height: ballHeight } = ball.getBoundingClientRect();

		function getCoords(id, relativeToField = false) {
			const elem =  document.getElementById(id);
			const { left, right, top, bottom } = elem.getBoundingClientRect();

			const elemCoords = {
				left: left + elem.clientLeft, //elemX + elemBorderLeftWidth
				right: left + elem.clientLeft + elem.clientWidth,
				top: top + elem.clientTop, //elemY + elemBorderTopWidth
				bottom: top + elem.clientTop + elem.clientHeight,
			};

			if(relativeToField) {
				const fieldCoords = getCoords('field');
				return {
					left: elemCoords.left - fieldCoords.left,
					right: elemCoords.right - fieldCoords.left,
					top: elemCoords.top - fieldCoords.top,
					bottom: elemCoords.bottom - fieldCoords.top,
				}
			}
			return elemCoords;
		}

		let intervalId;
		let timeoutId;

    function moveTheBall(e){
			const { left: fieldLeft, top: fieldTop } = getCoords('field');
			const { left: ballInitialLeft } = getCoords('ball', true);

			let ballX = e.clientX - fieldLeft;
			let ballY = e.clientY - fieldTop;

			ballX = Math.max(ballX - ballWidth/2, 0); //left edge case handle
			ballY = Math.max(ballY - ballHeight/2, 0); //top edge case handle

			ballX = Math.min(ballX, field.clientWidth - ballWidth); //right edge case handle
			ballY = Math.min(ballY, field.clientHeight - ballHeight); //bottom edge case handle

			const initialHorizontalSpeed = Math.min(Math.abs(ballInitialLeft - ballX) / 15, 3);
			const initialHorizontalDirection = ballX - ballInitialLeft >= 0 ? 1 : -1;

			ball.style.transition = 'all 0.4s';
      ball.style.top = ballY + 'px';
      ball.style.left = ballX + 'px';

			clearTimeout(timeoutId);
			clearInterval(intervalId);
			timeoutId = setTimeout(() => {
				ball.style.transition = '';
				freeFall({ vx: initialHorizontalSpeed, dx: initialHorizontalDirection });
			}, 400);
    }

		function moveTheBallHorizontally({ dx = 1, vx = 0 }){
			const { left, bottom } = getCoords('ball', true);
			const { right: fieldRight, bottom: fieldBottom } = getCoords('field', true);

			let newLeft = left + (dx * vx);

			if(vx > 0.1){
				if(dx === 1){
					if(newLeft >= fieldRight - ball.clientWidth){
						newLeft = fieldRight - ball.clientWidth;
						dx = -dx;
					}
					ball.style.left = newLeft + 'px';
				} else {
					if(newLeft <= 0){
						newLeft = 0;
						dx = -dx;
					}
					ball.style.left = newLeft + 'px';
				}
			} else {
				vx = 0;
			}

			return [dx, vx];
		}

		function freeFall({vy = 0, vx = 2, dy = 1, dx = 1} = {}) {
			clearInterval(intervalId);
			const {bottom: fieldBottom } = getCoords('field', true);

			intervalId = setInterval(() => {
				vy += dy * g;
				const { top, bottom } = getCoords('ball', true);
				const diffY = Math.abs(bottom - fieldBottom);

				[dx, vx] = moveTheBallHorizontally({ dx, vx });

				if(diffY > vy){
					ball.style.top = top + vy + 'px';
				} else {
					ball.style.top = fieldBottom - ball.clientHeight + 'px';
					clearInterval(intervalId);

					if(vy > 0.25){
						jumpTheBall({ vy: vy * e, vx, dx });
					}
				}
			}, 10)
		}

		function jumpTheBall({ vy = 0, vx = 0, dx = 1, dy = -1 }) {
			clearInterval(intervalId);

			intervalId = setInterval(() => {
				const { top } = getCoords('ball', true);
				const { right: fieldRight } = getCoords('field', true);

				vy += dy * g;

				[dx, vx] = moveTheBallHorizontally({ dx, vx });

				ball.style.top = top - vy + 'px';

				if(vy < g){
					vy = 0;
					clearInterval(intervalId);
					freeFall({ vx, dx });
				}
			}, 10)
		}

		freeFall();

    field.addEventListener('click', moveTheBall);

		function writeMouseCoords(e){
			const mouseCoords = document.querySelectorAll('.mouse-coords .coordinates');
			mouseCoords[0].innerHTML = 'X : ' + e.clientX;
			mouseCoords[1].innerHTML = 'Y : ' + e.clientY;
		}
		
		function writeFieldCoords() {
			const {width, height, top, left} = field.getBoundingClientRect();

			const fieldOuterCoords = document.querySelectorAll('.field-coords .outer-coords .coordinates');
			fieldOuterCoords[0].innerHTML = 'X : ' + left;
			fieldOuterCoords[1].innerHTML = 'Y : ' + top;

			const fieldInnerCoords = document.querySelectorAll('.field-coords .inner-coords .coordinates');
			fieldInnerCoords[0].innerHTML = 'X : ' + (left + field.clientLeft);
			fieldInnerCoords[1].innerHTML = 'Y : ' + (top + field.clientTop);

			const fieldWidth = document.querySelector('.field-width');
			const fieldHeight = document.querySelector('.field-height');

			fieldWidth.innerHTML = 'Width : ' + width;
			fieldHeight.innerHTML = 'Height : ' + height;
		}


		function fillDots(){
			const { width: totalWidth, height: totalHeight } = field.getBoundingClientRect();

			const fragement = document.createDocumentFragment();

			const totalNumberOfDots = (Math.floor(totalWidth /10) * Math.floor(totalHeight / 20));
			for(let i = 0; i < totalNumberOfDots; i++){
				const dot = document.createElement('div');
				dot.innerHTML = '. ';
				dot.style.cssText = `
					display: inline-block;
					height: 20px;
					margin: 0 3px;
				`;
				fragement.append(dot);
			}
			field.append(fragement);
		}
		fillDots();

		writeFieldCoords();
		document.addEventListener('mousemove', writeMouseCoords);
	</script>
</body>
</html>